# no built-in rules please
.SUFFIXES:

DIR=build_cc
BUILD_DIR=../build

QEMU_A64=qemu-aarch64-static
QEMU_A32=qemu-arm-static
QEMU_X64=qemu-x86_64-static

LEXER_BENCH=$(BUILD_DIR)/lexer_bench.exe
PP=$(BUILD_DIR)/pp.exe
EMIT_IR=$(BUILD_DIR)/compiler.exe
# CODEGEN_X64 = $(BUILD_DIR)/x64_codegen_tool.exe
# CODEGEN_A64 = $(BUILD_DIR)/a64_codegen_tool.exe
# CODEGEN_A32 = $(BUILD_DIR)/a32_codegen_tool.exe
CODEGEN_X64 = ../BE/CodeGenX64/codegen.py
CODEGEN_A64 = ../BE/CodeGenA64/codegen.py
CODEGEN_A32 = ../BE/CodeGenA32/codegen.py

$(info $(shell mkdir -p $(DIR)))

LANG_TESTS := $(wildcard LangTest/*_test.cw)
LANG_SOURCES := $(wildcard LangTest/*.cw)

DATA_SOURCES := $(wildcard TestData/*.cw)

LIB_TESTS := $(wildcard Lib/*_test.cw)
LIB_SOURCES :=  $(wildcard Lib/*.cw)

ALL_SOURCES := $(LANG_SOURCES) $(LIB_SOURCES) $(DATA_SOURCES)
ALL_SOURCES_GENERIC :=  $(filter $(wildcard */*gen.cw), $(ALL_SOURCES))
ALL_SOURCES_NO_GENERIC :=  $(filter-out $(wildcard */*gen.cw), $(ALL_SOURCES))
ALL_SOURCES_NO_GENERIC_NO_BUILTIN :=  $(filter-out $(wildcard */builtin.cw), $(ALL_SOURCES_NO_GENERIC))

tests: $(EMIT_IR) tests_meta assimilation_after_opt_tests
	@echo "PASSED $@"

############################################################
# Code Gen
############################################################

cwast_gen.cc: cwast.py
	@echo "[$@]"
	$(PYPY) ./cwast.py gen_cc <$@ > $(DIR)/$@.tmp
	@mv $(DIR)/$@.tmp $@

cwast_gen.h: cwast.py
	@echo "[$@]"
	$(PYPY) ./cwast.py gen_h <$@ > $(DIR)/$@.tmp
	@mv $(DIR)/$@.tmp $@

lexer_gen.cc: lexer_tab.py
	@echo "[$@]"
	$(PYPY) ./lexer_tab.py gen_cc <$@ > $(DIR)/$@.tmp
	@mv $(DIR)/$@.tmp $@

lexer_gen.h: lexer_tab.py
	@echo "[$@]"
	$(PYPY) ./lexer_tab.py gen_h <$@ > $(DIR)/$@.tmp
	@mv $(DIR)/$@.tmp $@

GENERATED = cwast_gen.cc cwast_gen.h lexer_gen.cc  lexer_gen.h


############################################################
# C++
############################################################

$(LEXER_BENCH)::
	@cd $(BUILD_DIR); $(MAKE) -s lexer_bench.exe

$(PP)::
	@cd $(BUILD_DIR); $(MAKE) -s pp.exe

$(EMIT_IR)::
	@cd $(BUILD_DIR); $(MAKE) -s compiler.exe

run_lexer_bench: $(LEXER_BENCH)
	/bin/time -p $(LEXER_BENCH)  Lib/*cw TestData/*cw  LangTest/*cw  > /dev/null

############################################################
# TESTING
############################################################

tests_meta: $(ALL_SOURCES_NO_GENERIC:%.cw=$(DIR)/%.cw.meta)
	@echo "PASSED $@"

$(DIR)/%.cw.meta: %.cw
	@echo "[typify $@]"
	$(EMIT_IR) -arch x64 -dump_stats $< >$@


############################################################
# ASSIMILATION TESTING
############################################################

assimilation_after_opt_tests: $(ALL_SOURCES_NO_GENERIC_NO_BUILTIN:%.cw=$(DIR)/%.cw.assim)
	@echo "PASSED $@"

PHASE =
# PHASE =  -dump_ast after_partial_eval
# PHASE =  -dump_ast after_optimization
# PHASE =  -dump_ast after_eliminate_span_and_union
# PHASE =  -dump_ast after_large_arg_conversion
# PHASE =  -dump_ast after_legalize
# PHASE =  -dump_ast after_name_cleanup

# PHASE =  -dump_types after_optimization

$(DIR)/%.cw.assim: %.cw
	@echo "[assim $@]"
	$(EMIT_IR) -arch x64 $(PHASE) $< > $@.cc_ast
	./compiler.py -arch x64 $(PHASE) $< > $@.py_ast
	diff $@.py_ast $@.cc_ast

############################################################
# Profile
#############################################################
# For profiling to work, run this as root first:
# echo "-1" > /proc/sys/kernel/perf_event_paranoid
#
# to examine the profile use
# perf report
XXX1 =  Lib/*cw
XXX2 = $(XXX1) $(XXX1)
XXX3 = $(XXX2) $(XXX2)
XXX4 = $(XXX3) $(XXX3)
XXX5 = $(XXX4) $(XXX4)
XXX6 = $(XXX5) $(XXX5)
XXX7 = $(XXX6) $(XXX6)

profile_lexer: $(LEXER_BENCH)
	perf record -g -F max $(LEXER_BENCH) -m parser $(XXX7) $(XXX5) $(XXX1)

benchmark_lexer: $(LEXER_BENCH)
	/bin/time -p $(LEXER_BENCH) -m parser $(XXX7) $(XXX5) $(XXX1)

profile_compiler: $(EMIT_IR)
	perf record -g -F max $(EMIT_IR) $(filter-out $(wildcard */*gen.cw), $(LIB_SOURCES))

benchmark_emit_ir: $(EMIT_IR)
	/bin/time -p $(EMIT_IR) $(filter-out $(wildcard */*gen.cw), $(LIB_SOURCES))


STD_LIB_WITH_ARGV_X64 = ../BE/StdLib/startup.x64.asm ../BE/StdLib/syscall.x64.asm
STD_LIB_WITH_ARGV_A64 = ../BE/StdLib/startup.a64.asm ../BE/StdLib/syscall.a64.asm
STD_LIB_WITH_ARGV_A32 = ../BE/StdLib/startup.a32.asm ../BE/StdLib/syscall.a32.asm


$(DIR)/cmatrix.x64.exe: TestData/cmatrix_exe.cw
	$(EMIT_IR) $< > $@.asm
	cat $(STD_LIB_WITH_ARGV_X64) $@.asm | $(CODEGEN_X64) -mode binary - $@
	chmod u+rx $@
	${QEMU_X64} $@




all:: $(LEXER_BENCH) $(PP) $(EMIT_IR)

clean:
	@echo cleaning and setting up build dirs
	@rm -rf $(DIR)/*
	@mkdir -p  $(DIR)
	@mkdir -p  $(DIR)/Lib
	@mkdir -p  $(DIR)/TestData
	@mkdir -p  $(DIR)/LangTest
	@mkdir -p  $(DIR)/FailTest